{% extends "base.html" %}
{% block title %}Round {{ round_record.id }} · {{ classroom.name }}{% endblock %}
{% block content %}
  <div class="mb-6 flex flex-wrap items-center justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold">Round {{ round_record.id }} results</h1>
      <p class="text-sm text-gray-600 dark:text-gray-300">Autosave is enabled. Homework wrong counts are auto-computed from round preset.</p>
    </div>
    <div class="flex gap-2">
      <a
        href="{{ url_for('classroom_exceptions', classroom_id=classroom.id) }}"
        class="rounded-2xl border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 transition hover:border-amber-400 hover:text-amber-700 dark:border-gray-700 dark:text-gray-200"
      >Exceptions queue</a>
      <a
        href="{{ url_for('export_round', classroom_id=classroom.id, round_id=round_record.id) }}"
        class="rounded-2xl border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 transition hover:border-emerald-400 hover:text-emerald-600 dark:border-gray-700 dark:text-gray-200"
      >Export CSV</a>
    </div>
  </div>

  {% if success %}
    <div class="mb-4 rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm text-emerald-700 dark:border-emerald-700/40 dark:bg-emerald-900/40 dark:text-emerald-200">{{ success }}</div>
  {% endif %}
  {% if error %}
    <div class="mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700 dark:border-red-700/40 dark:bg-red-900/40 dark:text-red-200">{{ error }}</div>
  {% endif %}

  <div class="mb-5 grid gap-4 md:grid-cols-3">
    <div class="rounded-2xl border border-gray-200 bg-white/90 p-4 text-sm shadow-sm dark:border-gray-700 dark:bg-gray-800/90">
      <div class="text-xs uppercase text-gray-500">Open Issues</div>
      <div class="mt-2 font-semibold">Unresolved results: {{ unresolved_count }}</div>
      <div class="font-semibold">Missing notation: {{ missing_notation_count }}</div>
    </div>
    <div class="rounded-2xl border border-gray-200 bg-white/90 p-4 text-sm shadow-sm dark:border-gray-700 dark:bg-gray-800/90">
      <div class="text-xs uppercase text-gray-500">Round Policy</div>
      <div class="mt-2">Total questions: {{ round_record.homework_total_questions }}</div>
      <div>Missing policy: {{ round_record.missing_homework_policy }}</div>
      <div>Metric mode: {{ round_record.homework_metric_mode }}</div>
    </div>
    <div class="rounded-2xl border border-gray-200 bg-white/90 p-4 text-sm shadow-sm dark:border-gray-700 dark:bg-gray-800/90">
      <div class="text-xs uppercase text-gray-500">Autosave</div>
      <div id="autosave_status" class="mt-2 font-semibold">Idle</div>
      <div class="text-xs text-gray-500">Debounce: 800ms</div>
    </div>
  </div>

  <div class="mb-4 flex flex-wrap gap-2">
    <button type="button" id="bulk_tie" class="rounded-xl bg-sky-600 px-3 py-2 text-xs font-semibold text-white">Set unresolved to tie</button>
    <button type="button" id="bulk_clear" class="rounded-xl bg-gray-700 px-3 py-2 text-xs font-semibold text-white">Clear unresolved results</button>
    <button type="button" id="bulk_hw_full" class="rounded-xl bg-emerald-600 px-3 py-2 text-xs font-semibold text-white">Set all submitted + full correct</button>
    <button type="button" id="bulk_absent" class="rounded-xl bg-rose-600 px-3 py-2 text-xs font-semibold text-white">Mark all absent</button>
    <button type="button" id="bulk_present" class="rounded-xl bg-indigo-600 px-3 py-2 text-xs font-semibold text-white">Mark all present</button>
  </div>

  <form method="post" class="space-y-6" id="round_form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <input type="hidden" name="action" id="form_action" value="save" />

    <section class="rounded-3xl border border-gray-200 bg-white/90 p-5 dark:border-gray-700 dark:bg-gray-800/90">
      <h2 class="text-lg font-semibold">Attendance</h2>
      <div class="mt-3 grid gap-2 sm:grid-cols-2">
        {% for student_id, record in attendance_map.items() %}
          {% set student = student_map.get(student_id) %}
          <label class="flex items-center justify-between rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-900/60">
            <span>{{ student.name if student else ('Student #' ~ student_id) }}</span>
            <select name="attendance_status_{{ student_id }}" class="rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs dark:border-gray-600 dark:bg-gray-900 attendance-select">
              <option value="present" {% if record.status == 'present' %}selected{% endif %}>Present</option>
              <option value="late" {% if record.status == 'late' %}selected{% endif %}>Late</option>
              <option value="absent" {% if record.status == 'absent' %}selected{% endif %}>Absent</option>
              <option value="excused" {% if record.status == 'excused' %}selected{% endif %}>Excused</option>
            </select>
          </label>
        {% endfor %}
      </div>
    </section>

    <div class="space-y-4">
      {% for match in matches %}
        {% set white = student_map.get(match.white_student_id) %}
        {% set black = student_map.get(match.black_student_id) %}
        {% set diag = diagnostics | selectattr('match_id', 'equalto', match.id) | list | first %}
        <div class="rounded-3xl border border-gray-200 bg-white/90 p-5 shadow-sm dark:border-gray-700 dark:bg-gray-800/90 match-card" data-match-id="{{ match.id }}">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <p class="text-sm text-gray-500">Match {{ loop.index }}</p>
              <h2 class="text-lg font-semibold">
                {{ white.name if white else 'TBD' }}
                <span class="text-xs text-gray-400">({{ match.white_strength or 'n/a' }})</span>
                <span class="text-gray-400">vs</span>
                {{ black.name if black else 'Bye' }}
                <span class="text-xs text-gray-400">({{ match.black_strength or 'n/a' }})</span>
              </h2>
            </div>
            <div class="text-xs text-gray-500">
              Last updated: {{ match.updated_at.strftime('%Y-%m-%d %H:%M') if match.updated_at else 'n/a' }}
            </div>
          </div>

          <div class="mt-2 text-xs text-gray-500">
            Repeat opponents before this round: {{ diag.repeat_count if diag else 0 }} ·
            Color diff pressure (W/B): {{ diag.white_color_diff if diag else 0 }} / {{ diag.black_color_diff if diag else 0 }}
          </div>

          <div class="mt-4 grid gap-4 md:grid-cols-4">
            <div>
              <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Result</label>
              {% if black is none %}
                <p class="mt-2 rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-900/60">Bye (auto)</p>
              {% else %}
                <select
                  name="result_{{ match.id }}"
                  class="mt-2 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm autosave-field result-field dark:border-gray-600 dark:bg-gray-900"
                  data-match-id="{{ match.id }}"
                >
                  <option value="" {% if not match.result %}selected{% endif %}>Not recorded</option>
                  <option value="white" {% if match.result == 'white' %}selected{% endif %}>{{ white.name }} wins</option>
                  <option value="black" {% if match.result == 'black' %}selected{% endif %}>{{ black.name }} wins</option>
                  <option value="tie" {% if match.result == 'tie' %}selected{% endif %}>Tie/Draw</option>
                </select>
              {% endif %}
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">White homework</label>
              <div class="mt-2 space-y-2">
                <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="white_submitted_{{ match.id }}" value="1" {% if match.homework_entry and match.homework_entry.white_submitted %}checked{% endif %} class="autosave-field" data-match-id="{{ match.id }}" /> Submitted</label>
                <input
                  name="white_correct_{{ match.id }}"
                  type="number"
                  min="0"
                  value="{{ match.homework_entry.white_correct if match.homework_entry else 0 }}"
                  class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm autosave-field homework-correct dark:border-gray-600 dark:bg-gray-900"
                  data-match-id="{{ match.id }}"
                  placeholder="Correct"
                />
                <input
                  name="white_incorrect_{{ match.id }}"
                  type="number"
                  min="0"
                  value="{{ match.homework_entry.white_incorrect if match.homework_entry else 0 }}"
                  class="w-full rounded-xl border border-gray-300 bg-gray-50 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-900"
                  placeholder="Wrong (auto)"
                  readonly
                />
              </div>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Black homework</label>
              <div class="mt-2 space-y-2">
                <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="black_submitted_{{ match.id }}" value="1" {% if match.homework_entry and match.homework_entry.black_submitted %}checked{% endif %} class="autosave-field" data-match-id="{{ match.id }}" /> Submitted</label>
                <input
                  name="black_correct_{{ match.id }}"
                  type="number"
                  min="0"
                  value="{{ match.homework_entry.black_correct if match.homework_entry else 0 }}"
                  class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm autosave-field homework-correct dark:border-gray-600 dark:bg-gray-900"
                  data-match-id="{{ match.id }}"
                  placeholder="Correct"
                />
                <input
                  name="black_incorrect_{{ match.id }}"
                  type="number"
                  min="0"
                  value="{{ match.homework_entry.black_incorrect if match.homework_entry else 0 }}"
                  class="w-full rounded-xl border border-gray-300 bg-gray-50 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-900"
                  placeholder="Wrong (auto)"
                  readonly
                />
              </div>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Notation</label>
              <div class="mt-2 space-y-2 text-xs">
                <label class="flex items-center gap-2"><input type="checkbox" name="notation_white_{{ match.id }}" value="1" {% if match.notation_submitted_white %}checked{% endif %} class="autosave-field" data-match-id="{{ match.id }}" /> White submitted</label>
                {% if black %}
                  <label class="flex items-center gap-2"><input type="checkbox" name="notation_black_{{ match.id }}" value="1" {% if match.notation_submitted_black %}checked{% endif %} class="autosave-field" data-match-id="{{ match.id }}" /> Black submitted</label>
                {% else %}
                  <span class="text-gray-500">Bye round</span>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="mt-4">
            <label class="text-xs font-semibold text-gray-600 dark:text-gray-300">Notes</label>
            <input
              name="notes_{{ match.id }}"
              type="text"
              value="{{ match.notes }}"
              placeholder="Shared notes for both players"
              class="mt-2 w-full rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm autosave-field dark:border-gray-600 dark:bg-gray-900"
              data-match-id="{{ match.id }}"
            />
          </div>
        </div>
      {% endfor %}
    </div>

    <section class="rounded-3xl border border-gray-200 bg-white/90 p-5 dark:border-gray-700 dark:bg-gray-800/90">
      <h2 class="text-lg font-semibold">Completion Guardrail</h2>
      <div class="mt-3 space-y-2 text-sm">
        <label class="flex items-center gap-2"><input type="checkbox" name="override_completion" value="1" /> Override completion guardrail</label>
        <input name="override_reason" type="text" placeholder="Required reason if overriding" class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-900" />
      </div>
    </section>

    <div class="grid gap-3 md:grid-cols-2">
      <button type="submit" class="w-full rounded-2xl bg-gray-700 px-4 py-3 text-sm font-semibold text-white shadow-lg transition hover:bg-gray-600" onclick="document.getElementById('form_action').value='save'">Save draft</button>
      <button type="submit" class="w-full rounded-2xl bg-emerald-600 px-4 py-3 text-sm font-semibold text-white shadow-lg transition hover:bg-emerald-500" onclick="document.getElementById('form_action').value='complete'">Save + Complete round</button>
    </div>
  </form>

  <script>
    (function() {
      const totalQuestions = {{ round_record.homework_total_questions or 0 }};
      const csrf = {{ csrf_token|tojson }};
      const autosaveUrl = {{ url_for('autosave_round_result', classroom_id=classroom.id, round_id=round_record.id)|tojson }};
      const statusEl = document.getElementById('autosave_status');
      const timers = new Map();

      function setStatus(text, isError = false) {
        statusEl.textContent = text;
        statusEl.className = isError ? 'mt-2 font-semibold text-red-600' : 'mt-2 font-semibold text-emerald-600';
      }

      function clampHomework(card) {
        ['white', 'black'].forEach((side) => {
          const correctInput = card.querySelector(`input[name="${side}_correct_${card.dataset.matchId}"]`);
          const wrongInput = card.querySelector(`input[name="${side}_incorrect_${card.dataset.matchId}"]`);
          if (!correctInput || !wrongInput) return;
          const raw = Number(correctInput.value || 0);
          const bounded = Math.max(0, totalQuestions > 0 ? Math.min(totalQuestions, raw) : raw);
          if (Number.isFinite(bounded)) {
            correctInput.value = String(Math.trunc(bounded));
          }
          if (totalQuestions > 0) {
            wrongInput.value = String(Math.max(0, totalQuestions - Number(correctInput.value || 0)));
          }
        });
      }

      async function autosaveMatch(matchId) {
        const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
        if (!card) return;
        clampHomework(card);
        const formData = new FormData();
        formData.append('csrf_token', csrf);
        formData.append('match_id', String(matchId));
        card.querySelectorAll('input, select').forEach((el) => {
          if (!el.name) return;
          if (el.type === 'checkbox') {
            formData.append(el.name, el.checked ? '1' : '0');
          } else {
            formData.append(el.name, el.value || '');
          }
        });

        setStatus(`Saving match ${matchId}...`);
        try {
          const response = await fetch(autosaveUrl, { method: 'POST', body: formData });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          setStatus(`Saved at ${new Date().toLocaleTimeString()}`);
        } catch (error) {
          setStatus(`Autosave failed for match ${matchId}`, true);
        }
      }

      function scheduleAutosave(matchId) {
        if (timers.has(matchId)) clearTimeout(timers.get(matchId));
        timers.set(matchId, setTimeout(() => autosaveMatch(matchId), 800));
      }

      document.querySelectorAll('.autosave-field').forEach((el) => {
        el.addEventListener('input', () => scheduleAutosave(el.dataset.matchId));
        el.addEventListener('change', () => scheduleAutosave(el.dataset.matchId));
      });

      document.querySelectorAll('.match-card').forEach((card) => clampHomework(card));

      function setUnresolvedResults(value) {
        document.querySelectorAll('.result-field').forEach((select) => {
          const shouldUpdate = value === '' ? select.value !== '' : select.value === '';
          if (shouldUpdate) {
            select.value = value;
            scheduleAutosave(select.dataset.matchId);
          }
        });
      }

      document.getElementById('bulk_tie').addEventListener('click', () => setUnresolvedResults('tie'));
      document.getElementById('bulk_clear').addEventListener('click', () => setUnresolvedResults(''));
      document.getElementById('bulk_hw_full').addEventListener('click', () => {
        document.querySelectorAll('.match-card').forEach((card) => {
          const id = card.dataset.matchId;
          ['white', 'black'].forEach((side) => {
            const submitted = card.querySelector(`input[name="${side}_submitted_${id}"]`);
            const correct = card.querySelector(`input[name="${side}_correct_${id}"]`);
            if (submitted) submitted.checked = true;
            if (correct && totalQuestions > 0) correct.value = String(totalQuestions);
          });
          scheduleAutosave(id);
        });
      });

      function setAllAttendance(status) {
        document.querySelectorAll('.attendance-select').forEach((el) => {
          el.value = status;
        });
      }
      document.getElementById('bulk_absent').addEventListener('click', () => setAllAttendance('absent'));
      document.getElementById('bulk_present').addEventListener('click', () => setAllAttendance('present'));
    })();
  </script>
{% endblock %}
